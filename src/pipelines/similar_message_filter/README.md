# 相似消息过滤管道

此管道用于过滤短时间内内容高度相似的重复消息，减少消息冗余，适用于直播弹幕、评论等场景。

## 功能特点

- 自动检测短时间内相似度高的消息并过滤掉重复的消息
- 可配置相似度阈值、时间窗口等参数
- 支持消息类型过滤，可以只对特定类型的消息进行过滤
- 支持跨用户消息过滤，可以过滤不同用户发送的相似消息
- 保留最先出现的消息，丢弃后续相似消息
- 不修改任何消息内容，只决定是否传递消息

## 工作原理

1. 当有新消息到达时，将其与缓存中的历史消息比较
2. 计算新消息与历史消息的相似度
3. 如果相似度超过阈值，将新消息标记为重复，并丢弃（不传递给后续管道）
4. 如果没有相似消息，则保留该消息并加入缓存，正常传递给后续管道
5. 定期清理过期的消息缓存，以避免内存占用过高

## 配置说明

在 `config.toml` 文件中，可以配置以下参数：

```toml
[similar_message_filter]
# 消息类型过滤，只处理这些类型的消息
message_types = ["text"]

# 消息相似度阈值 (0.0-1.0)
similarity_threshold = 0.85

# 检查窗口的时间范围（秒）
time_window = 60.0

# 最小消息长度
min_message_length = 3

# 是否跨用户过滤相似消息
cross_user_filter = true
```

### 参数详解

- `message_types`: 要处理的消息类型列表，只有符合这些类型的消息才会被考虑过滤
- `similarity_threshold`: 消息相似度阈值（0.0-1.0），高于此值的消息被视为相似并被过滤
- `time_window`: 检查窗口的时间范围（秒），只检查此时间范围内的消息
- `min_message_length`: 最小处理消息长度，低于此长度的消息不会被过滤
- `cross_user_filter`: 是否跨用户过滤相似消息，设为 `true` 时可以过滤不同用户发送的相似消息

## 启用方法

在 Amaidesu 主配置文件中添加此管道的优先级配置：

```toml
[pipelines]
# 其他管道配置...
similar_message_filter = 300  # 设置优先级，数值越小优先级越高
```

## 注意事项

- 相似度计算基于编辑距离算法，适用于文本内容
- 过低的相似度阈值可能导致不相关消息被错误过滤
- 过高的相似度阈值可能导致相似消息无法被过滤
- 时间窗口越大，内存占用越高，但过滤效果可能更好
- 此管道会完全丢弃被判定为相似的消息，后续管道将无法接收到这些消息
- 启用跨用户过滤时，来自不同用户的相似消息中，只有最先出现的那条会被保留

## 应用场景

- 直播弹幕系统：过滤重复的观众弹幕评论（如"？？？"、"666"等）
- 聊天机器人：减少重复内容的响应
- 任何需要减少消息冗余的场景 